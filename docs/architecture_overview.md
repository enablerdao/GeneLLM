# GeneLLM アーキテクチャ概要

このドキュメントでは、GeneLLMのシステムアーキテクチャと主要コンポーネント間の相互作用について説明します。

## システム概要

GeneLLMは、C言語で実装された軽量な自然言語処理システムです。大規模な深層学習モデルとは異なり、形態素解析と独自のルールベースアプローチを組み合わせることで、最小限のリソースで動作する効率的なAIシステムを提供します。

## アーキテクチャ図

```
                  ┌─────────────────┐
                  │     ユーザー     │
                  └────────┬────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────┐
│                   main.c                        │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────┐ │
│  │ コマンドライン │  │  対話モード  │  │ ファイル  │ │
│  │   インタフェース │  │            │  │  モード   │ │
│  └──────┬──────┘  └──────┬──────┘  └────┬─────┘ │
└─────────┼───────────────┼───────────────┼───────┘
          │               │               │
          └───────────────┼───────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────┐
│              improved_router_model.c            │
│  ┌─────────────┐  ┌─────────────┐  ┌──────────┐ │
│  │  テキスト解析 │  │ エージェント  │  │ トピック  │ │
│  │             │  │   選択      │  │  分類     │ │
│  └──────┬──────┘  └──────┬──────┘  └────┬─────┘ │
└─────────┼───────────────┼───────────────┼───────┘
          │               │               │
          ▼               │               ▼
┌─────────────────┐       │        ┌─────────────────┐
│  形態素解析     │       │        │  知識ベース検索   │
│  (MeCab)       │       │        │  (knowledge_    │
│                │       │        │   manager.c)    │
└────────┬───────┘       │        └────────┬────────┘
         │               │                 │
         └───────┐       │       ┌─────────┘
                 ▼       ▼       ▼
         ┌─────────────────────────────┐
         │    応答生成                  │
         │ (improved_response_         │
         │  generator.c)               │
         └──────────────┬──────────────┘
                        │
                        ▼
         ┌─────────────────────────────┐
         │    学習モジュール             │
         │  (learning_module.c)        │
         └──────────────┬──────────────┘
                        │
                        ▼
                  ┌─────────────────┐
                  │     ユーザー     │
                  └─────────────────┘
```

## 主要コンポーネント

### 1. メインプログラム (`src/main.c`)

メインプログラムは、GeneLLMのエントリーポイントであり、以下の責任を持ちます：

- コマンドライン引数の解析
- 実行モードの選択（単一質問、対話、ファイル）
- 初期化処理（知識ベース、学習モジュール、ベクトルDB）
- テキスト入力の受け取りとルーターへの転送
- 応答の表示と整形

### 2. ルーターモデル (`src/improved_router_model.c`)

ルーターモデルは、入力テキストを分析し、適切なエージェントに処理を振り分ける役割を担います：

- テキストの形態素解析
- エージェント評価スコアの計算
- トピック分類
- 最適なエージェントの選択
- 応答生成の調整

### 3. 知識管理システム (`src/include/knowledge_manager.c`)

知識管理システムは、知識ベースの管理と検索を担当します：

- 知識ドキュメントの読み込みと解析
- カテゴリとタグによる分類
- キーワード検索
- ベクトル検索との連携
- 新しい知識の追加と保存

### 4. ベクトル検索エンジン (`src/vector_search/vector_search.c`)

ベクトル検索エンジンは、テキストのベクトル表現と類似度計算を行います：

- テキストのベクトル化
- コサイン類似度計算
- 最近傍検索
- ベクトルデータベースの管理
- 単語埋め込みの処理

### 5. 学習モジュール (`src/include/learning_module.c`)

学習モジュールは、過去の質問と回答を記録し、類似質問の検索機能を提供します：

- 質問と回答のペアの保存
- 類似質問の検索
- 確信度スコアの計算
- 学習データベースの管理

### 6. 応答生成器 (`src/include/improved_response_generator.c`)

応答生成器は、選択されたエージェントと知識ベースの情報を基に応答を生成します：

- テンプレートベースの応答生成
- 知識ベースからの情報抽出
- 応答の整形と調整
- 外部LLMとの連携（オプション）

## データフロー

GeneLLMにおけるデータの流れは以下の通りです：

1. ユーザーが質問を入力
2. メインプログラムが入力を受け取り、ルーターモデルに転送
3. ルーターモデルがテキストを解析し、最適なエージェントを選択
4. 選択されたエージェントが知識ベースから関連情報を検索
5. ベクトル検索エンジンが意味的に類似した情報を検索
6. 応答生成器が検索結果を基に応答を生成
7. 学習モジュールが質問と応答のペアを記録
8. 生成された応答がユーザーに表示

## メモリ管理

GeneLLMは効率的なメモリ管理を実現するために以下の戦略を採用しています：

1. **静的メモリ割り当て**: 可能な限り動的メモリ割り当てを避け、静的配列を使用
2. **バッファサイズの最適化**: 各種バッファサイズを用途に合わせて調整
3. **メモリプール**: 頻繁に使用されるオブジェクトのためのメモリプール実装
4. **参照カウント**: 共有リソースの効率的な管理のための参照カウント
5. **早期解放**: 不要になったメモリの早期解放

## スレッディングモデル

現在のGeneLLMは主にシングルスレッドで動作しますが、以下の部分で並列処理の可能性があります：

1. **ベクトル検索**: 大規模なベクトルデータベースでの検索を並列化
2. **形態素解析**: 長いテキストの解析を並列化
3. **知識ベース検索**: 複数のカテゴリやファイルの同時検索

## エラー処理

GeneLLMは以下のエラー処理戦略を採用しています：

1. **エラーコード**: 関数は成功/失敗を示すエラーコードを返す
2. **ログ記録**: エラーは詳細な情報とともにログに記録
3. **グレースフルデグラデーション**: 一部の機能が失敗しても、システム全体は動作を継続
4. **リカバリメカニズム**: 重要なコンポーネントの障害からの回復メカニズム

## 拡張性

GeneLLMは以下の方法で拡張可能です：

1. **新しいエージェント**: 専門知識を持つ新しいエージェントの追加
2. **知識ベースの拡張**: 新しいカテゴリやドキュメントの追加
3. **外部サービス連携**: APIを通じた外部サービスとの連携
4. **カスタム応答生成器**: 特定のドメイン向けの応答生成ロジックの実装
5. **プラグインシステム**: 動的ロード可能なプラグインの開発

## パフォーマンス最適化

GeneLLMのパフォーマンスを最適化するための戦略：

1. **キャッシング**: 頻繁に使用される計算結果のキャッシング
2. **インデックス**: 高速検索のための知識ベースのインデックス作成
3. **ベクトル量子化**: ベクトル表現の効率的な保存と検索
4. **バッチ処理**: 複数のクエリのバッチ処理
5. **プリロード**: 起動時に重要なデータをメモリにプリロード

## 今後の開発方向

GeneLLMの今後の開発方向は以下の通りです：

1. **分散アーキテクチャ**: 複数のノードでの分散処理
2. **ハードウェアアクセラレーション**: GPUやTPUを活用した高速化
3. **マルチモーダル対応**: テキスト以外のデータ（画像、音声など）の処理
4. **自己学習機能**: システムの自動改善メカニズム
5. **セキュリティ強化**: 入力検証とサニタイズの強化

## 関連ドキュメント

- [メインプログラム詳細](main_program.md)
- [知識管理システム詳細](knowledge_system.md)
- [ベクトル検索エンジン詳細](vector_search.md)
- [学習モジュール詳細](learning_module.md)
- [ルーターモデル詳細と改善案](router_model.md)